name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Verify before building release artifacts ────────────────────────
  test:
    name: Pre-release tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run all workspace tests
        run: cargo test --workspace
      - name: Clippy (release mode)
        run: cargo clippy --workspace --release -- -Dwarnings

  # ── WASM artifacts (platform-independent) ────────────────────────────
  wasm:
    name: Build WASM
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM crypto
        working-directory: crates/salvium-crypto
        run: |
          RUSTFLAGS="-Ctarget-feature=+simd128" \
            wasm-pack build --target web --out-dir ../../src/crypto/wasm

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-artifacts
          path: |
            src/crypto/wasm/salvium_crypto_bg.wasm
            src/crypto/wasm/salvium_crypto.js
            src/crypto/wasm/salvium_crypto.d.ts

  # ── Native miner binaries ────────────────────────────────────────────
  miner:
    name: "Build miner (${{ matrix.name }})"
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            name: salvium-miner-linux-x86_64
            cross: true

          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            name: salvium-miner-linux-aarch64
            cross: true

          - target: x86_64-apple-darwin
            os: macos-13
            name: salvium-miner-macos-x86_64

          - target: aarch64-apple-darwin
            os: macos-latest
            name: salvium-miner-macos-aarch64

          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: salvium-miner-windows-x86_64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Install cross (Linux)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Install cmake (macOS)
        if: runner.os == 'macOS'
        run: brew install cmake

      - name: Install cmake (Windows)
        if: runner.os == 'Windows'
        run: choco install cmake --installargs '"ADD_CMAKE_TO_PATH=System"' -y

      - name: Build with cross (Linux)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }} -p salvium-miner

      - name: Build native (macOS/Windows)
        if: ${{ !matrix.cross }}
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            export RUSTFLAGS="-C target-feature=+crt-static"
          fi
          cargo build --release --target ${{ matrix.target }} -p salvium-miner

      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/salvium-miner \
             ${{ matrix.name }}

      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: |
          copy target\${{ matrix.target }}\release\salvium-miner.exe ^
               ${{ matrix.name }}
        shell: cmd

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}

  # ── Create release (on this repo or push to public releases repo) ───
  release:
    name: Publish release
    needs: [wasm, miner]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # Miner binaries
          for dir in artifacts/salvium-miner-*; do
            name=$(basename "$dir")
            cp "$dir/$name" "release/$name"
            chmod +x "release/$name" 2>/dev/null || true
          done

          # WASM files
          cp artifacts/wasm-artifacts/src/crypto/wasm/salvium_crypto_bg.wasm release/

          # Generate checksums
          cd release
          sha256sum * > checksums.sha256
          cat checksums.sha256

      # Option A: Release on this repo (works for both public and private)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release/*

      # Option B: Push to public releases repo (uncomment and set RELEASES_PAT)
      # To enable: create a PAT with repo scope, add as RELEASES_PAT secret,
      # and set RELEASES_REPO to e.g. "salvium/salvium-rs-releases"
      #
      # - name: Push to public releases repo
      #   if: env.RELEASES_REPO != ''
      #   env:
      #     RELEASES_REPO: ${{ vars.RELEASES_REPO }}
      #     GH_TOKEN: ${{ secrets.RELEASES_PAT }}
      #   run: |
      #     TAG="${GITHUB_REF#refs/tags/}"
      #     gh release create "$TAG" release/* \
      #       --repo "$RELEASES_REPO" \
      #       --title "$TAG" \
      #       --notes "Automated release from salvium-rs $TAG"
